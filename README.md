# SM4 and optimizations

## SM4 多线程优化

### 基于T函数的优化

在国密SM4算法中，分为明文处理和产生密钥两大部分，而在这两部分中都有一个T函数，其主要负责置换和移位。置换部分由s盒担任，因为有32比特的置换，每个s盒只能负责8比特，所以一共需要4个s盒。而对于该T函数的置换算法，s盒与s盒之间是相互独立进行的，所以我们可以对于s盒的置换创建4个线程，每个线程负责一个s盒的置换，这样同时运行可以优化其性能。

## 运用多线程同时加密多组明文

国密SM4属于密码中的分组密码，其一次只能操作128比特的明文加密，对于大于128比特的明文，需要将其分成n个128比特的组，对于每组分别加密，最后将加密好的密文拼接起来。对于每组的加密，其相互之间其实是相互独立的，我们可以基于创建多个进程，每个进程负责一组明文的加密工作，以此来提升程序性能。

## 循环展开

在sm4中不涉及到串行循环的变量，即没有依赖的变量，我们进行循环展开，提升算法性能。

## 查表法

SM4加/解密轮函数中的T变换由非线性变换τ和线性变换L构成。将非线性变换τ的输入记为$X=(x0, x1, x2, x3)∈({Z_2}^8)^4$，输出记为$Y=(y0, y1, y2, y3)∈({Z_2}^8)^4$。可将非线性变换τ的操作定义如下。

$$y_i = Sbox(x_i) , 0 \leq i < 4   (1)$$

将线性变换L的输入记为$P=(p0, p1, …, pn-1)∈({Z_2}^8)^4$，输出记为$Q=(q0, q1, …, qn-1)∈({Z_2}^8)^4$。其中，$m$大小需为SM4使用S盒规模的倍数，$m$与$n$的关系满足$n=32/m$。由于L中仅包含循环移位和异或操作。因此，可将线性变换L的操作定义为式(2)，非线性变换T操作可由式(1)与式(2)合并表示为式(3)：

$$Q = L(B) = L(p_0 << (n-1)m) \oplus L(p_1 <<(n-2)m) \oplus \cdots \oplus L(p_{n-1})(2)$$

$$Q = T(X) =L(Sbox(x_0) << (n-1)m) \oplus L(Sbox(x_1) << (n-2)m) \oplus \cdots \oplus L(Sbox(x_{n-1}))(3)$$

这里可将非线性变换T的操作制成4个8-bit输入32-bit输出的表：

$$T3[d_0] = L(Sbox(d_0) << 24)$$

$$T2[d_1] = L(Sbox(d_1) << 16)$$

$$T1[d_2] = L(Sbox(d_2) << 8)$$

$$T0[d_3] = L(Sbox(d_3));d_i \in [0,255], 0 \leq i < 4$$
